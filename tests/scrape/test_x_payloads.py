import datetime
import json
import pathlib

from dank.scrape.x.payloads import (
    XAsset,
    XExtractedPost,
    extract_posts_from_payload,
)


def test_extract_posts_and_assets_from_watcher_guru_payload() -> None:
    path = (
        pathlib.Path(__file__).parent.parent
        / "fixtures"
        / "UserTweetsWactherGuruExample.json"
    )

    with path.open("r", encoding="utf-8") as file:
        payload = json.load(file)

    expected = [
        XExtractedPost(
            post_id="2019987790369296512",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-07T04:13:13+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019987790369296512"
            ),
            payload={"rest_id": "2019987790369296512"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAhwMKwXgAAlWeN.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019952473859821896",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-07T01:52:53+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019952473859821896"
            ),
            payload={"rest_id": "2019952473859821896"},
            assets=(),
        ),
        XExtractedPost(
            post_id="2019901810350416285",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T22:31:34+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019901810350416285"
            ),
            payload={"rest_id": "2019901810350416285"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAgh_aLXYAE4GbJ.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAgh_aBWYAENmaT.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019896801881641384",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T22:11:40+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019896801881641384"
            ),
            payload={"rest_id": "2019896801881641384"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAgdb20WsAAaBsf.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAgdb21XMAElln2.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019879824790114514",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T21:04:12+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019879824790114514"
            ),
            payload={"rest_id": "2019879824790114514"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAgN_nHXAAAJQt3.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019849760933572890",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T19:04:44+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019849760933572890"
            ),
            payload={"rest_id": "2019849760933572890"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAfypeIXMAA1NC9.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019834324770607141",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T18:03:24+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019834324770607141"
            ),
            payload={"rest_id": "2019834324770607141"},
            assets=(),
        ),
        XExtractedPost(
            post_id="2019829746100760891",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T17:45:12+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019829746100760891"
            ),
            payload={"rest_id": "2019829746100760891"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAfgcwrXsAA9JYD.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019820177639239888",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T17:07:11+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019820177639239888"
            ),
            payload={"rest_id": "2019820177639239888"},
            assets=(),
        ),
        XExtractedPost(
            post_id="2019806319344259113",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T16:12:07+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019806319344259113"
            ),
            payload={"rest_id": "2019806319344259113"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAfLI9TakAAIwA9.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAfLI9WbEAAoH7_.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019800548648649206",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T15:49:11+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019800548648649206"
            ),
            payload={"rest_id": "2019800548648649206"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAfF5PrWIAA6kGn.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAfF5PoWAAAHdS5.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019797793057943868",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T15:38:14+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019797793057943868"
            ),
            payload={"rest_id": "2019797793057943868"},
            assets=(),
        ),
        XExtractedPost(
            post_id="2019795196272062814",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T15:27:55+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019795196272062814"
            ),
            payload={"rest_id": "2019795196272062814"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAfBBo-W8AAt6q5.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAfBBo6XQAAQYF4.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019765452839227657",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T13:29:44+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019765452839227657"
            ),
            payload={"rest_id": "2019765452839227657"},
            assets=(),
        ),
        XExtractedPost(
            post_id="2019677459227217951",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T07:40:04+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019677459227217951"
            ),
            payload={"rest_id": "2019677459227217951"},
            assets=(),
        ),
        XExtractedPost(
            post_id="2019649163517129207",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T05:47:38+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019649163517129207"
            ),
            payload={"rest_id": "2019649163517129207"},
            assets=(),
        ),
        XExtractedPost(
            post_id="2019573277673582793",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T00:46:05+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019573277673582793"
            ),
            payload={"rest_id": "2019573277673582793"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAb3MUMWcAA1zgE.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019570014777700455",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T00:33:07+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019570014777700455"
            ),
            payload={"rest_id": "2019570014777700455"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAb0OZ8WMAAJen3.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAb0OaRWAAEubBJ.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019567103997800515",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T00:21:33+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019567103997800515"
            ),
            payload={"rest_id": "2019567103997800515"},
            assets=(),
        ),
        XExtractedPost(
            post_id="2019563570745471068",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-06T00:07:31+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019563570745471068"
            ),
            payload={"rest_id": "2019563570745471068"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/media/"
                        "HAbuXQnX0AA6LW3.jpg"
                    ),
                    asset_type="photo",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019504056809443654",
            author="WatcherGuru",
            created_at=datetime.datetime.fromisoformat(
                "2026-02-05T20:11:02+00:00",
            ),
            url=(
                "https://x.com/WatcherGuru/status/"
                "2019504056809443654"
            ),
            payload={"rest_id": "2019504056809443654"},
            assets=(
                XAsset(
                    url=(
                        "https://pbs.twimg.com/"
                        "amplify_video_thumb/2019503894544474112/img/"
                        "X1bFYVOwf_Q3ZjJC.jpg"
                    ),
                    asset_type="video",
                    should_download=True,
                ),
                XAsset(
                    url=(
                        "https://video.twimg.com/"
                        "amplify_video/2019503894544474112/"
                        "vid/avc1/358x270/BtGlN5Afa_JJnAAA.mp4?tag=24"
                    ),
                    asset_type="video",
                    should_download=True,
                ),
                XAsset(
                    url=(
                        "https://video.twimg.com/"
                        "amplify_video/2019503894544474112/"
                        "vid/avc1/476x360/OF7oXVaPwk4_RlyV.mp4?tag=24"
                    ),
                    asset_type="video",
                    should_download=True,
                ),
                XAsset(
                    url=(
                        "https://video.twimg.com/"
                        "amplify_video/2019503894544474112/"
                        "vid/avc1/954x720/-mvG6BaEFVR68rJc.mp4?tag=24"
                    ),
                    asset_type="video",
                    should_download=True,
                ),
            ),
        ),
        XExtractedPost(
            post_id="2019269738728468765",
            author="",
            created_at=None,
            url="https://x.com/i/status/2019269738728468765",
            payload={"rest_id": "2019269738728468765"},
            assets=(),
        ),
    ]

    actual = [
        post._replace(payload={"rest_id": post.post_id})
        for post in extract_posts_from_payload(payload)
    ]

    assert actual == expected
